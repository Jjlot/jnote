#+STARTUP: showall

* Compile OVS on CentOS 7
** Before compile
   yum install make gcc curl wget vim openssl-devel autoconf automake rpm-build libtool redhat-rpm-config python-devel openssl-devel kernel-devel kernel-debug-devel gcc-c++ unbound-devel unbound python-sphinx

   ./boot.sh

   ./configure

   make rpm-fedora

   Target is under ./rpm/rpmbuild/RPMS/

* ovs commands   
** Ovsdb commands
   ovsdb-client list-dbs

   ovsdb-client list-tables Open_vSwitch

   ovsdb-client dump Open_vSwitch Bridge

** ovs-ofctl
*** Check openflow version
    ovs-ofctl -V

    ovs-ofctl dump-flows br0 table=7

** ovs-vscctl

   ovs-vsctl add-port br-ex vxlan-1 -- set interface vxlan-1 type=vxlan options:remote_ip=192.168.100.3

   ovs-vsctl add-port br-ex ovn-7788 -- set interface ovn-7788 type=geneve options:remote_ip=192.168.100.3

** ovn commands   
   ovs-vsctl set open . external-ids:ovn-encap-ip=10.0.0.10

   ovs-vsctl set open . external-ids:ovn-encap-type=stt

** ovs-ofctl
   ovs-ofctl add-flow br-int table=0,priority=103,dl_type=0x0800,nw_dst=100.1.1.1,actions=output:1

   ovs-ofctl add-flow br-int table=0,priority=101,dl_type=0x0800,nw_dst=111.1.1.100,actions=mod_dl_src=00:11:22:33:44:55,mod_dl_dst=00:55:44:33:22:11,mod_nw_src=10.0.0.26,output:2

   ovs-ofctl add-flow br-int table=0,priority=101,in_port=3,actions=mod_dl_src=00:11:22:33:44:55,mod_dl_dst=00:55:44:33:22:11,mod_nw_dst=10.0.0.26,output:3

   ovs-ofctl add-flow br-int table=0,priority=102,in_port=2,actions=output:3

   
* Using ovs for dpdk

** Compile dpdk

   yum install gcc make numactl-devel python2 python36 diffutils

   export DPDK_DIR=/usr/src/dpdk-18.11

   export DPDK_TARGET=x86_64-native-linuxapp-gcc

   export DPDK_BUILD=$DPDK_DIR/$DPDK_TARGET

   export LD_LIBRARY_PATH=$DPDK_DIR/x86_64-native-linuxapp-gcc/lib

   make install T=$DPDK_TARGET DESTDIR=install

** Compile OVS

   ./configure --with-dpdk=$DPDK_BUILD

   make

** Start ovs

   $DPDK_DIR/usertools/dpdk-devbind.py --bind=vfio-pci eth1 eth2

   $DPDK_DIR/usertools/dpdk-devbind.py --status

   export PATH=$PATH:/usr/local/share/openvswitch/scripts

   ovs-ctl start

** Add dpdk interface

   ovs-vsctl add-br br0 -- set bridge br0 datapath_type=netdev

   ovs-vsctl add-port br0 port700 -- set Interface port700 type=dpdk options:dpdk-devargs=0000:07:00.0

*** Create veth interface

    ovs-docker add-port br0 eth1 <container-id>

*** Create vhost-user interface

    # /usr/local/var/run/openvswitch/vhost-user0
    ovs-vsctl add-port br0 vhost-user0 -- set Interface vhost-user0 type=dpdkvhostuser
    
** Flow table configuration

*** Show port id

    ovs-ofctl show br0

*** Add flow table

    ovs-ofctl add-flow br0 in_port=6,idle_timeout=0,action=output:2

*** Show flow tables

    ovs-ofctl dump-flows br0

** Check ovs dpdk and hugepage configuration

   ovs-vsctl --no-wait get Open_vSwitch . other_config

** Start docker

   docker run -itd --privileged --name=dpdk-docker  -v /dev/hugepages:/mnt/huge -v /usr/local/var/run/openvswitch:/var/run/openvswitch dpdk-docker

** Run l2fwd

   ./l2fwd -c 0x01 -n 1  --socket-mem=1024  --no-pci --vdev=net_virtio_user0,mac=00:00:00:00:00:05,path=/var/run/openvswitch/vhost-user0 --vdev=net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1 -- -p 0x3

